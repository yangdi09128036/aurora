import{s as e,n as t,m as a,b as s,p as r,a as o,r as c,c as l,w as i,i as n,o as d,d as u,e as p,q as h,u as f,F as m,t as _,g as y,j as g,S as w,h as b,ae as v,a8 as k,x as C,f as S,af as T}from"./index-El_S5awX.js";import{_ as I}from"./uni-popup.BTNAO5Zm.js";import{r as O}from"./uni-app.es.DUfiIcRS.js";import{s as P}from"./store.D9vwEKqx.js";import{_ as D}from"./left.CpwphMH_.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";const R=L({computed:{userInfo:()=>P.userInfo},data:()=>({tabs:["全部","待付款","待分享","待发货","待收货","评价"],currentTab:0,orderList:{0:[],1:[],2:[],3:[],4:[],5:[]},orderCounts:{1:0,2:0,3:0,4:0,5:0},randomGoods:[],reviewContent:"",currentOrderForReview:null,shareCountdown:5,shareTimer:null}),onLoad(e){if(e.type){const t={pending:1,share:2,shipping:3,receiving:4,review:5};this.currentTab=t[e.type]||0}this.loadOrderData(),this.getRandomGoods()},onShow(){this.loadOrderData()},onUnload(){this.shareTimer&&clearInterval(this.shareTimer)},methods:{async loadOrderData(){try{if(!this.userInfo||!this.userInfo._id)return void e({title:"请先登录",icon:"none"});const s=t.database();for(let e=1;e<=5;e++)this.orderCounts[e]=0;let r={userId:this.userInfo._id};switch(this.currentTab){case 1:r.paymentStatus=0;break;case 2:r.paymentStatus=1,r.shareStatus=0;break;case 3:r.paymentStatus=1,r.shippingStatus=0;break;case 4:r.shippingStatus=1,r.deliveryStatus=0;break;case 5:r.deliveryStatus=1,r.review=s.command.exists(!0)}const o=await s.collection("order").where(r).orderBy("createdAt","desc").get();if(o.result.data?(this.orderList[this.currentTab]=o.result.data,3===this.currentTab&&this.orderList[this.currentTab].length>0&&this.orderList[this.currentTab].forEach((e=>{0===e.shippingStatus&&this.startAutoShipping(e)}))):this.orderList[this.currentTab]=[],0===this.currentTab){const e=await s.collection("order").where({userId:this.userInfo._id}).orderBy("createdAt","desc").get();e.result.data?this.orderList[0]=e.result.data:this.orderList[0]=[]}await this.getOrderCounts(),a("orderCounts",this.orderCounts)}catch(s){console.error("加载订单数据失败:",s),e({title:"加载订单数据失败",icon:"none"})}},async getOrderCounts(){try{const e=t.database(),a=[e.collection("order").where({userId:this.userInfo._id,paymentStatus:0}).count(),e.collection("order").where({userId:this.userInfo._id,paymentStatus:1,shareStatus:0}).count(),e.collection("order").where({userId:this.userInfo._id,paymentStatus:1,shippingStatus:0}).count(),e.collection("order").where({userId:this.userInfo._id,shippingStatus:1,deliveryStatus:0}).count(),e.collection("order").where({userId:this.userInfo._id,deliveryStatus:1,review:e.command.exists(!0)}).count()],s=await Promise.all(a);for(let t=0;t<s.length;t++)this.orderCounts[t+1]=s[t].result.total}catch(e){console.error("获取订单数量失败:",e)}},async getRandomGoods(){try{const{result:e}=await t.database().collection("mall-goods").limit(8).get();this.randomGoods=this.shuffleArray(e.data||[])}catch(e){console.error("获取商品数据失败:",e)}},shuffleArray(e){if(!Array.isArray(e))return[];const t=[...e];for(let a=t.length-1;a>0;a--){const e=Math.floor(Math.random()*(a+1));[t[a],t[e]]=[t[e],t[a]]}return t},getOrderStatus:e=>0===e.paymentStatus?"待付款":1===e.paymentStatus&&0===e.shareStatus?"待分享":1===e.paymentStatus&&0===e.shippingStatus?"待发货":1===e.shippingStatus&&0===e.deliveryStatus?"待收货":1!==e.deliveryStatus||e.review?"已完成":"待评价",switchTab(e){this.currentTab=e,this.loadOrderData(),console.log(`切换到选项卡 ${e}，数据:`,this.orderList[e])},handleSwiperChange(e){this.currentTab=e.detail.current,this.loadOrderData(),console.log(`切换到选项卡 ${this.currentTab}，数据:`,this.orderList[this.currentTab])},async goToPay(e){var t;const r={amount:e.amount,userId:this.userInfo._id,username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:(null==(t=this.userInfo.avatar_file)?void 0:t.path)||"/static/avatar-default.png",productId:e.productId,productName:e.productName,productImage:e.productImage,quantity:e.quantity};a("paymentData",r),a("currentOrderIds",[e._id]),s({url:"/pages/wallet/pay"})},async cancelOrder(a){try{const s=t.database();await s.collection("order").doc(a._id).update({paymentStatus:2}),e({title:"订单已取消",icon:"success"}),this.loadOrderData()}catch(s){console.error("取消订单失败:",s),e({title:"取消订单失败",icon:"none"})}},shareOrderWithDelay(e){this.shareCountdown=3,this.$refs.sharePopup.open(),this.shareTimer=setInterval((()=>{this.shareCountdown--,this.shareCountdown<=0&&(clearInterval(this.shareTimer),this.$refs.sharePopup.close(),this.shareOrder(e))}),1e3)},async shareOrder(a){try{const s=t.database();await s.collection("order").doc(a._id).update({shareStatus:1}),e({title:"分享成功",icon:"success"}),this.loadOrderData(),setTimeout((async()=>{try{await s.collection("order").doc(a._id).update({shippingStatus:1}),console.log("订单自动发货成功:",a._id),this.loadOrderData()}catch(e){console.error("自动发货失败:",e)}}),3e3)}catch(s){console.error("分享订单失败:",s),e({title:"分享失败",icon:"none"})}},async confirmReceipt(a){try{const e=t.database();await e.collection("order").doc(a._id).update({deliveryStatus:1}),this.showReviewPopup(a),this.loadOrderData()}catch(s){console.error("确认收货失败:",s),e({title:"确认收货失败",icon:"none"})}},showReviewPopup(t){this.currentOrderForReview=t,this.reviewContent="",this.$refs.reviewPopup?this.$refs.reviewPopup.open():(console.error("评价弹窗组件不存在"),e({title:"评价功能暂时不可用",icon:"none"}))},hideReviewPopup(){this.$refs.reviewPopup&&this.$refs.reviewPopup.close(),this.currentOrderForReview=null,this.reviewContent=""},async submitReview(){if(this.reviewContent.trim())try{const a=t.database();await a.collection("order").doc(this.currentOrderForReview._id).update({review:this.reviewContent,updatedAt:(new Date).getTime()}),e({title:"评价成功",icon:"success"}),this.hideReviewPopup(),this.loadOrderData()}catch(a){console.error("提交评价失败:",a),e({title:"提交评价失败",icon:"none"})}else e({title:"请输入评价内容",icon:"none"})},navigateToProduct(e){e&&r({key:"currentProduct",data:e,success:()=>{s({url:"../search/mall-details"})}})},navigateBack(){o({url:"/pages/user/user"})},handleScroll(){},startAutoShipping(e){setTimeout((async()=>{try{const a=t.database();await a.collection("order").doc(e._id).update({shippingStatus:1}),console.log("订单自动发货成功:",e._id),this.loadOrderData()}catch(a){console.error("自动发货失败:",a)}}),5e3)},navigateToProductDetails(a){if(!a)return void e({title:"商品信息不完整",icon:"none"});console.log("跳转商品详情页的商品id",a);t.database().collection("mall-goods").doc(a).get().then((t=>{console.log("跳转商品详情页的商品数据",t.result.data[0]),t.result.data?r({key:"currentProduct",data:t.result.data[0],success:()=>{s({url:"../search/mall-details"})}}):e({title:"商品不存在或已下架",icon:"none"})})).catch((t=>{console.error("获取商品详情失败:",t),e({title:"获取商品详情失败",icon:"none"})}))}}},[["render",function(e,t,a,s,r,o){const P=n,L=y,R=g,x=w,F=b,A=T,q=v,$=k,j=O(c("uni-popup"),I);return d(),l(P,{class:"container"},{default:i((()=>[u(P,{class:"fixed-header"},{default:i((()=>[u(P,{class:"status-bar"}),u(P,{class:"nav-header"},{default:i((()=>[u(P,{class:"back-icon",onClick:o.navigateBack},{default:i((()=>[u(L,{src:D,class:"icon-back"})])),_:1},8,["onClick"]),u(R,{class:"page-title"},{default:i((()=>[p("我的订单")])),_:1})])),_:1}),u(x,{"scroll-x":"true",class:"tab-scroll","scroll-into-view":"tab"+r.currentTab,"scroll-with-animation":!0,onScroll:o.handleScroll},{default:i((()=>[u(P,{class:"tabs"},{default:i((()=>[(d(!0),h(m,null,f(r.tabs,((e,t)=>(d(),l(P,{key:t,id:"tab"+t,class:C(["tab-item",{active:r.currentTab===t}]),onClick:e=>o.switchTab(t)},{default:i((()=>[p(_(e)+" ",1),r.currentTab===t?(d(),l(P,{key:0,class:"tab-line"})):S("",!0)])),_:2},1032,["id","class","onClick"])))),128))])),_:1})])),_:1},8,["scroll-into-view","onScroll"])])),_:1}),u(q,{class:"swiper-content",current:r.currentTab,onChange:o.handleSwiperChange},{default:i((()=>[(d(!0),h(m,null,f(r.tabs,((e,t)=>(d(),l(A,{key:t},{default:i((()=>[u(x,{"scroll-y":"true",class:"order-list"},{default:i((()=>[u(P,{class:"orders-section"},{default:i((()=>[r.orderList[t]&&r.orderList[t].length>0&&5!==r.currentTab?(d(!0),h(m,{key:0},f(r.orderList[t],((e,t)=>(d(),l(P,{key:t,class:"order-item"},{default:i((()=>[u(P,{class:"store-info"},{default:i((()=>[u(L,{class:"store-icon",src:"/assets/avatar-default-Cd0nErh8.png",mode:"aspectFit"}),u(R,{class:"store-name"},{default:i((()=>[p("拼多多官方旗舰店")])),_:1}),u(R,{class:"order-status"},{default:i((()=>[p(_(o.getOrderStatus(e)),1)])),_:2},1024)])),_:2},1024),u(P,{class:"product-info",onClick:t=>o.navigateToProductDetails(e.productId)},{default:i((()=>[u(P,{class:"product-details"},{default:i((()=>[u(L,{src:e.productImage,mode:"aspectFill",class:"product-image"},null,8,["src"]),u(R,{class:"product-name"},{default:i((()=>[p(_(e.productName),1)])),_:2},1024),u(R,{class:"product-desc"},{default:i((()=>[p(_(e.description),1)])),_:2},1024),u(P,{class:"price-info"},{default:i((()=>[u(R,{class:"quantity"},{default:i((()=>[p("x"+_(e.quantity),1)])),_:2},1024),u(R,{class:"price"},{default:i((()=>[p("¥"+_(e.amount),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"]),u(P,{class:"order-actions"},{default:i((()=>[0===r.currentTab?(d(),h(m,{key:0},[0===e.paymentStatus?(d(),h(m,{key:0},[u(F,{class:"action-btn cancel",onClick:t=>o.cancelOrder(e)},{default:i((()=>[p("取消订单")])),_:2},1032,["onClick"]),u(F,{class:"action-btn primary",onClick:t=>o.goToPay(e)},{default:i((()=>[p("去支付")])),_:2},1032,["onClick"])],64)):1===e.paymentStatus&&0===e.shareStatus?(d(),h(m,{key:1},[u(F,{class:"action-btn cancel",onClick:t=>o.cancelOrder(e)},{default:i((()=>[p("取消订单")])),_:2},1032,["onClick"]),u(F,{class:"action-btn primary",onClick:t=>o.shareOrderWithDelay(e)},{default:i((()=>[p("去分享")])),_:2},1032,["onClick"])],64)):1===e.shippingStatus&&0===e.deliveryStatus?(d(),l(F,{key:2,class:"action-btn primary",onClick:t=>o.confirmReceipt(e)},{default:i((()=>[p("确认收货")])),_:2},1032,["onClick"])):S("",!0)],64)):1===r.currentTab?(d(),h(m,{key:1},[u(F,{class:"action-btn cancel",onClick:t=>o.cancelOrder(e)},{default:i((()=>[p("取消订单")])),_:2},1032,["onClick"]),u(F,{class:"action-btn primary",onClick:t=>o.goToPay(e)},{default:i((()=>[p("去支付")])),_:2},1032,["onClick"])],64)):2===r.currentTab?(d(),h(m,{key:2},[u(F,{class:"action-btn cancel",onClick:t=>o.cancelOrder(e)},{default:i((()=>[p("取消订单")])),_:2},1032,["onClick"]),u(F,{class:"action-btn primary",onClick:t=>o.shareOrderWithDelay(e)},{default:i((()=>[p("去分享")])),_:2},1032,["onClick"])],64)):4===r.currentTab?(d(),l(F,{key:3,class:"action-btn primary",onClick:t=>o.confirmReceipt(e)},{default:i((()=>[p("确认收货")])),_:2},1032,["onClick"])):S("",!0)])),_:2},1024)])),_:2},1024)))),128)):S("",!0),5===r.currentTab?(d(),h(m,{key:1},[r.orderList[t]&&r.orderList[t].length>0?(d(!0),h(m,{key:0},f(r.orderList[t],((e,t)=>(d(),l(P,{key:t,class:"order-item"},{default:i((()=>[u(P,{class:"store-info"},{default:i((()=>[u(L,{class:"store-icon",src:"/static/store.png",mode:"aspectFit"}),u(R,{class:"store-name"},{default:i((()=>[p("拼多多官方旗舰店")])),_:1}),u(R,{class:"order-status"},{default:i((()=>[p("已评价")])),_:1})])),_:1}),u(P,{class:"product-info",onClick:t=>o.navigateToProductDetails(e.productId)},{default:i((()=>[u(P,{class:"product-details"},{default:i((()=>[u(L,{src:e.productImage,mode:"aspectFill",class:"product-image"},null,8,["src"]),u(R,{class:"product-name"},{default:i((()=>[p(_(e.productName),1)])),_:2},1024),u(P,{class:"review-content"},{default:i((()=>[u(R,{class:"review-label"},{default:i((()=>[p("我的评价：")])),_:1}),u(R,{class:"review-text"},{default:i((()=>[p(_(e.review),1)])),_:2},1024)])),_:2},1024),u(P,{class:"price-info"},{default:i((()=>[u(R,{class:"quantity"},{default:i((()=>[p("x"+_(e.quantity),1)])),_:2},1024),u(R,{class:"price"},{default:i((()=>[p("¥"+_(e.amount),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])])),_:2},1024)))),128)):(d(),l(P,{key:1,class:"empty-state"},{default:i((()=>[u(L,{src:"/static/empty-order.png",mode:"aspectFit",class:"empty-icon"}),u(R,null,{default:i((()=>[p("您还没有相关的订单")])),_:1})])),_:1}))],64)):S("",!0),r.orderList[t]&&0!==r.orderList[t].length?S("",!0):(d(),l(P,{key:2,class:"empty-state"},{default:i((()=>[u(L,{src:"/static/empty-order.png",mode:"aspectFit",class:"empty-icon"}),u(R,null,{default:i((()=>[p("您还没有相关的订单")])),_:1})])),_:1}))])),_:2},1024),0!==r.currentTab&&5!==r.currentTab?(d(),l(P,{key:0,class:"content"},{default:i((()=>[u(P,{class:"recommend-title"},{default:i((()=>[p("- 为您推荐 -")])),_:1}),u(P,{class:"tab-content"},{default:i((()=>[(d(!0),h(m,null,f(r.randomGoods,((e,t)=>(d(),l(P,{key:t,class:"content-item"},{default:i((()=>[u(P,{class:"product-card",onClick:t=>o.navigateToProduct(e)},{default:i((()=>{var t;return[u(L,{class:"item-image",src:null==(t=e.goods_thumb)?void 0:t.fileID,mode:"aspectFill"},null,8,["src"]),u(P,{class:"product-info"},{default:i((()=>[u(R,{class:"item-title"},{default:i((()=>[p(_(e.name),1)])),_:2},1024),u(P,{class:"service-tags"},{default:i((()=>[u(R,{class:"tag pay-later"},{default:i((()=>[p("先用后付")])),_:1}),u(R,{class:"tag quick-refund"},{default:i((()=>[p("极速退款")])),_:1})])),_:1}),u(P,{class:"price-and-sales"},{default:i((()=>[u(R,{class:"price"},{default:i((()=>[p("¥"+_(e.price),1)])),_:2},1024),u(R,{class:"sales"},{default:i((()=>[p("全店已拼"+_(e.total_sell_count)+"+件",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)]})),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:2},1024)])),_:2},1024)):S("",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["current","onChange"]),u(j,{ref:"reviewPopup",type:"bottom"},{default:i((()=>[u(P,{class:"review-popup"},{default:i((()=>[u(P,{class:"popup-header"},{default:i((()=>[u(R,{class:"popup-title"},{default:i((()=>[p("商品评价")])),_:1}),u(R,{class:"popup-close",onClick:o.hideReviewPopup},{default:i((()=>[p("×")])),_:1},8,["onClick"])])),_:1}),u(P,{class:"review-content-popup"},{default:i((()=>[u($,{modelValue:r.reviewContent,"onUpdate:modelValue":t[0]||(t[0]=e=>r.reviewContent=e),placeholder:"请输入您的评价内容",class:"review-textarea"},null,8,["modelValue"]),u(F,{class:"submit-review",onClick:o.submitReview},{default:i((()=>[p("提交评价")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},512),u(j,{ref:"sharePopup",type:"center"},{default:i((()=>[u(P,{class:"share-popup"},{default:i((()=>[u(P,{class:"share-popup-content"},{default:i((()=>[u(R,{class:"share-popup-title"},{default:i((()=>[p("分享成功")])),_:1}),u(R,{class:"share-popup-text"},{default:i((()=>[p("3秒后将自动为您发货")])),_:1}),u(R,{class:"share-popup-countdown"},{default:i((()=>[p(_(r.shareCountdown)+"s",1)])),_:1})])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-eb06c2d7"]]);export{R as default};
