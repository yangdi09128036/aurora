import{s as e,n as t,m as s,b as i,a,r as l,c as o,w as c,i as r,o as d,d as n,e as u,t as h,q as m,u as p,F as f,f as _,g,j as I,h as y,S as k,x as b}from"./index-DyUMtph-.js";import{_ as v}from"./uni-icons.ksb_YqOd.js";import{r as S}from"./uni-app.es.BWQr3qZr.js";import{_ as C,a as x}from"./empty-box.4DnVf6Gp.js";import{s as w}from"./store.CDKRaDHf.js";import{_ as j}from"./left.CpwphMH_.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=D({data:()=>({historyItems:[],selectedItems:[],isAllSelected:!1,isLoading:!1,page:1,pageSize:10}),computed:{totalPrice(){return this.historyItems.filter((e=>this.selectedItems.includes(e._id))).reduce(((e,t)=>e+t.price),0).toFixed(2)},userInfo:()=>w.userInfo},onLoad(){this.loadhistoryItems()},methods:{async loadhistoryItems(){try{if(!this.userInfo||!this.userInfo._id)return void e({title:"请先登录",icon:"none"});this.isLoading=!0;const s=t.database(),i=await s.collection("history").where({userId:this.userInfo._id}).skip((this.page-1)*this.pageSize).limit(this.pageSize).get();if(0===i.result.data.length)return this.isLoading=!1,void(1===this.page&&(this.historyItems=[]));const a=i.result.data.map((e=>e.productId)),l=(await s.collection("mall-goods").where({_id:s.command.in(a)}).get()).result.data;this.historyItems=1===this.page?l:[...this.historyItems,...l],this.page++}catch(s){console.error("加载历史商品失败:",s),e({title:"加载历史商品失败",icon:"none"})}finally{this.isLoading=!1}},loadMoreItems(){this.isLoading||this.loadhistoryItems()},toggleSelect(e){const t=this.selectedItems.indexOf(e._id);-1===t?this.selectedItems.push(e._id):this.selectedItems.splice(t,1),this.isAllSelected=this.selectedItems.length===this.historyItems.length},toggleSelectAll(){this.isAllSelected?this.selectedItems=[]:this.selectedItems=this.historyItems.map((e=>e._id)),this.isAllSelected=!this.isAllSelected},async handleCheckout(){var a;if(0===this.selectedItems.length)return void e({title:"请选择商品",icon:"none"});const l=this.historyItems.filter((e=>this.selectedItems.includes(e._id))),o={amount:parseFloat(this.totalPrice),username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:(null==(a=this.userInfo.avatar_file)?void 0:a.path)||"/static/avatar-default.png",userId:this.userInfo._id,productId:this.selectedItems,productName:l.map((e=>e.name)).join(", "),productImage:l[0].goods_thumb.fileID,quantity:this.selectedItems.length};s("paymentData",o);try{const e=t.database(),a=[];for(const t of this.selectedItems){const s=this.historyItems.find((e=>e._id===t));if(s){const i=await e.collection("order").add({userId:this.userInfo._id,productId:[t],productName:s.name,productImage:s.goods_thumb.fileID,amount:s.price,quantity:1,paymentStatus:0,shareStatus:0,shippingStatus:0,deliveryStatus:0,reviewStatus:0});a.push(i.result.id)}}o.orderIds=a,s("paymentData",o),s("currentOrderIds",a),i({url:"/pages/wallet/pay"})}catch(c){console.error("创建订单失败:",c),e({title:"创建订单失败，请重试",icon:"none"})}},navBack(){a({url:"/pages/user/user"})},goToProductDetail(e){i({url:`/pages/search/mall-details?id=${e}`})},async removehistoryItem(s){try{const i=t.database();await i.collection("history").where({userId:this.userInfo._id,productId:s}).remove(),this.historyItems=this.historyItems.filter((e=>e._id!==s)),this.selectedItems=this.selectedItems.filter((e=>e!==s)),e({title:"已移除历史",icon:"success"})}catch(i){console.error("移除历史失败:",i),e({title:"移除历史失败，请重试",icon:"none"})}},goShopping(){a({url:"/pages/index/index"})}}},[["render",function(e,t,s,i,a,w){const D=g,A=r,L=I,F=y,P=S(l("uni-icons"),v),z=S(l("uni-load-more"),C),T=k;return d(),o(A,{class:"container"},{default:c((()=>[n(A,{class:"nav-bar"},{default:c((()=>[n(A,{class:"nav-left",onClick:w.navBack},{default:c((()=>[n(D,{src:j,class:"back-icon"})])),_:1},8,["onClick"]),n(A,{class:"nav-title"},{default:c((()=>[n(L,null,{default:c((()=>[u("我的历史")])),_:1})])),_:1}),n(A,{class:"nav-right",onClick:w.toggleSelectAll},{default:c((()=>[n(L,null,{default:c((()=>[u(h(a.isAllSelected?"取消全选":"全选"),1)])),_:1})])),_:1},8,["onClick"])])),_:1}),n(T,{"scroll-y":"true",class:"history-list",onScrolltolower:w.loadMoreItems},{default:c((()=>[0===a.historyItems.length?(d(),o(A,{key:0,class:"empty-state"},{default:c((()=>[n(D,{src:x,class:"empty-icon"}),n(L,null,{default:c((()=>[u("暂无历史商品")])),_:1}),n(F,{class:"go-shopping-btn",onClick:w.goShopping},{default:c((()=>[u("去逛逛")])),_:1},8,["onClick"])])),_:1})):(d(!0),m(f,{key:1},p(a.historyItems,(e=>(d(),o(A,{class:"history-item",key:e._id},{default:c((()=>[n(A,{class:"checkbox",onClick:t=>w.toggleSelect(e)},{default:c((()=>[n(A,{class:b(["checkbox-inner",{selected:a.selectedItems.includes(e._id)}])},{default:c((()=>[a.selectedItems.includes(e._id)?(d(),o(L,{key:0,class:"checkbox-icon"},{default:c((()=>[u("✓")])),_:1})):_("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"]),n(D,{src:e.goods_thumb.fileID,class:"product-image",mode:"aspectFill",onClick:t=>w.goToProductDetail(e._id)},null,8,["src","onClick"]),n(A,{class:"product-info",onClick:t=>w.goToProductDetail(e._id)},{default:c((()=>[n(A,{class:"product-name"},{default:c((()=>[u(h(e.name),1)])),_:2},1024),n(A,{class:"product-price"},{default:c((()=>[n(L,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(L,{class:"price-value"},{default:c((()=>[u(h(e.price.toFixed(2)),1)])),_:2},1024),e.original_price?(d(),o(L,{key:0,class:"original-price"},{default:c((()=>[u("¥"+h(e.original_price.toFixed(2)),1)])),_:2},1024)):_("",!0)])),_:2},1024),n(A,{class:"product-tags"},{default:c((()=>[e.is_hot?(d(),o(L,{key:0,class:"tag"},{default:c((()=>[u("热销")])),_:1})):_("",!0),e.is_new?(d(),o(L,{key:1,class:"tag"},{default:c((()=>[u("新品")])),_:1})):_("",!0),e.is_best?(d(),o(L,{key:2,class:"tag"},{default:c((()=>[u("精品")])),_:1})):_("",!0)])),_:2},1024)])),_:2},1032,["onClick"]),n(A,{class:"remove-btn",onClick:t=>w.removehistoryItem(e._id)},{default:c((()=>[n(P,{type:"trash",size:"20",color:"#999"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),a.isLoading?(d(),o(A,{key:2,class:"loading"},{default:c((()=>[n(z,{status:"loading"})])),_:1})):_("",!0)])),_:1},8,["onScrolltolower"]),a.historyItems.length>0?(d(),o(A,{key:0,class:"bottom-bar"},{default:c((()=>[n(A,{class:"total-section"},{default:c((()=>[n(L,{class:"total-label"},{default:c((()=>[u("合计：")])),_:1}),n(L,{class:"total-price"},{default:c((()=>[n(L,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(L,null,{default:c((()=>[u(h(w.totalPrice),1)])),_:1})])),_:1})])),_:1}),n(F,{class:"checkout-btn",onClick:w.handleCheckout,disabled:0===a.selectedItems.length},{default:c((()=>[u(" 去结算 ("+h(a.selectedItems.length)+") ",1)])),_:1},8,["onClick","disabled"])])),_:1})):_("",!0)])),_:1})}],["__scopeId","data-v-cb56fe60"]]);export{A as default};
