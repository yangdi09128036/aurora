import{s as e,n as t,m as s,b as a,a as l,r as o,c as i,w as c,i as r,o as d,d as n,e as u,t as m,q as f,u as h,F as p,f as _,g,j as I,h as v,S as k,x as y}from"./index-DyUMtph-.js";import{_ as b}from"./uni-icons.ksb_YqOd.js";import{r as S}from"./uni-app.es.BWQr3qZr.js";import{_ as C,a as x}from"./empty-box.4DnVf6Gp.js";import{s as w}from"./store.CDKRaDHf.js";import{_ as F}from"./left.CpwphMH_.js";import{_ as j}from"./_plugin-vue_export-helper.BCo6x5W8.js";const D=j({data:()=>({favorItems:[],selectedItems:[],isAllSelected:!1,isLoading:!1,page:1,pageSize:10}),computed:{totalPrice(){return this.favorItems.filter((e=>this.selectedItems.includes(e._id))).reduce(((e,t)=>e+t.price),0).toFixed(2)},userInfo:()=>w.userInfo},onLoad(){this.loadFavorItems()},methods:{async loadFavorItems(){try{if(!this.userInfo||!this.userInfo._id)return void e({title:"请先登录",icon:"none"});this.isLoading=!0;const s=t.database(),a=await s.collection("favor").where({userId:this.userInfo._id}).skip((this.page-1)*this.pageSize).limit(this.pageSize).get();if(0===a.result.data.length)return this.isLoading=!1,void(1===this.page&&(this.favorItems=[]));const l=a.result.data.map((e=>e.productId)),o=(await s.collection("mall-goods").where({_id:s.command.in(l)}).get()).result.data;this.favorItems=1===this.page?o:[...this.favorItems,...o],this.page++}catch(s){console.error("加载收藏商品失败:",s),e({title:"加载收藏商品失败",icon:"none"})}finally{this.isLoading=!1}},loadMoreItems(){this.isLoading||this.loadFavorItems()},toggleSelect(e){const t=this.selectedItems.indexOf(e._id);-1===t?this.selectedItems.push(e._id):this.selectedItems.splice(t,1),this.isAllSelected=this.selectedItems.length===this.favorItems.length},toggleSelectAll(){this.isAllSelected?this.selectedItems=[]:this.selectedItems=this.favorItems.map((e=>e._id)),this.isAllSelected=!this.isAllSelected},async handleCheckout(){var l;if(0===this.selectedItems.length)return void e({title:"请选择商品",icon:"none"});const o=this.favorItems.filter((e=>this.selectedItems.includes(e._id))),i=parseFloat(this.totalPrice);console.log("商品总价",i);const c={amount:i,username:this.userInfo.username,mobile:this.userInfo.mobile,avatar:(null==(l=this.userInfo.avatar_file)?void 0:l.path)||"/static/avatar-default.png",userId:this.userInfo._id,productId:this.selectedItems,productName:o.map((e=>e.name)).join(", "),productImage:o[0].goods_thumb.fileID,quantity:this.selectedItems.length};s("paymentData",c);try{const e=t.database(),l=[];for(const t of this.selectedItems){const s=this.favorItems.find((e=>e._id===t));if(s){const a=await e.collection("order").add({userId:this.userInfo._id,productId:[t],productName:s.name,productImage:s.goods_thumb.fileID,amount:s.price,quantity:1,paymentStatus:0,shareStatus:0,shippingStatus:0,deliveryStatus:0,reviewStatus:0});l.push(a.result.id)}}c.orderIds=l,s("paymentData",c),s("currentOrderIds",l),a({url:"/pages/wallet/pay"})}catch(r){console.error("创建订单失败:",r),e({title:"创建订单失败，请重试",icon:"none"})}},navBack(){l({url:"/pages/user/user"})},goToProductDetail(e){a({url:`/pages/search/mall-details?id=${e}`})},async removeFavorItem(s){try{const a=t.database();await a.collection("favor").where({userId:this.userInfo._id,productId:s}).remove(),this.favorItems=this.favorItems.filter((e=>e._id!==s)),this.selectedItems=this.selectedItems.filter((e=>e!==s)),e({title:"已移除收藏",icon:"success"})}catch(a){console.error("移除收藏失败:",a),e({title:"移除收藏失败，请重试",icon:"none"})}},goShopping(){l({url:"/pages/index/index"})}}},[["render",function(e,t,s,a,l,w){const j=g,D=r,A=I,L=v,P=S(o("uni-icons"),b),z=S(o("uni-load-more"),C),T=k;return d(),i(D,{class:"container"},{default:c((()=>[n(D,{class:"nav-bar"},{default:c((()=>[n(D,{class:"nav-left",onClick:w.navBack},{default:c((()=>[n(j,{src:F,class:"back-icon"})])),_:1},8,["onClick"]),n(D,{class:"nav-title"},{default:c((()=>[n(A,null,{default:c((()=>[u("我的收藏")])),_:1})])),_:1}),n(D,{class:"nav-right",onClick:w.toggleSelectAll},{default:c((()=>[n(A,null,{default:c((()=>[u(m(l.isAllSelected?"取消全选":"全选"),1)])),_:1})])),_:1},8,["onClick"])])),_:1}),n(T,{"scroll-y":"true",class:"favor-list",onScrolltolower:w.loadMoreItems},{default:c((()=>[0===l.favorItems.length?(d(),i(D,{key:0,class:"empty-state"},{default:c((()=>[n(j,{src:x,class:"empty-icon"}),n(A,null,{default:c((()=>[u("暂无收藏商品")])),_:1}),n(L,{class:"go-shopping-btn",onClick:w.goShopping},{default:c((()=>[u("去逛逛")])),_:1},8,["onClick"])])),_:1})):(d(!0),f(p,{key:1},h(l.favorItems,(e=>(d(),i(D,{class:"favor-item",key:e._id},{default:c((()=>[n(D,{class:"checkbox",onClick:t=>w.toggleSelect(e)},{default:c((()=>[n(D,{class:y(["checkbox-inner",{selected:l.selectedItems.includes(e._id)}])},{default:c((()=>[l.selectedItems.includes(e._id)?(d(),i(A,{key:0,class:"checkbox-icon"},{default:c((()=>[u("✓")])),_:1})):_("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"]),n(j,{src:e.goods_thumb.fileID,class:"product-image",mode:"aspectFill",onClick:t=>w.goToProductDetail(e._id)},null,8,["src","onClick"]),n(D,{class:"product-info",onClick:t=>w.goToProductDetail(e._id)},{default:c((()=>[n(D,{class:"product-name"},{default:c((()=>[u(m(e.name),1)])),_:2},1024),n(D,{class:"product-price"},{default:c((()=>[n(A,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(A,{class:"price-value"},{default:c((()=>[u(m(e.price.toFixed(2)),1)])),_:2},1024),e.original_price?(d(),i(A,{key:0,class:"original-price"},{default:c((()=>[u("¥"+m(e.original_price.toFixed(2)),1)])),_:2},1024)):_("",!0)])),_:2},1024),n(D,{class:"product-tags"},{default:c((()=>[e.is_hot?(d(),i(A,{key:0,class:"tag"},{default:c((()=>[u("热销")])),_:1})):_("",!0),e.is_new?(d(),i(A,{key:1,class:"tag"},{default:c((()=>[u("新品")])),_:1})):_("",!0),e.is_best?(d(),i(A,{key:2,class:"tag"},{default:c((()=>[u("精品")])),_:1})):_("",!0)])),_:2},1024)])),_:2},1032,["onClick"]),n(D,{class:"remove-btn",onClick:t=>w.removeFavorItem(e._id)},{default:c((()=>[n(P,{type:"trash",size:"20",color:"#999"})])),_:2},1032,["onClick"])])),_:2},1024)))),128)),l.isLoading?(d(),i(D,{key:2,class:"loading"},{default:c((()=>[n(z,{status:"loading"})])),_:1})):_("",!0)])),_:1},8,["onScrolltolower"]),l.favorItems.length>0?(d(),i(D,{key:0,class:"bottom-bar"},{default:c((()=>[n(D,{class:"total-section"},{default:c((()=>[n(A,{class:"total-label"},{default:c((()=>[u("合计：")])),_:1}),n(A,{class:"total-price"},{default:c((()=>[n(A,{class:"price-symbol"},{default:c((()=>[u("¥")])),_:1}),n(A,null,{default:c((()=>[u(m(w.totalPrice),1)])),_:1})])),_:1})])),_:1}),n(L,{class:"checkout-btn",onClick:w.handleCheckout,disabled:0===l.selectedItems.length},{default:c((()=>[u(" 去结算 ("+m(l.selectedItems.length)+") ",1)])),_:1},8,["onClick","disabled"])])),_:1})):_("",!0)])),_:1})}],["__scopeId","data-v-aa44b476"]]);export{D as default};
